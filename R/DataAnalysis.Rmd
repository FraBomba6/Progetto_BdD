---
title: "Analisi del database"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

```{r Libraries}
library("ggplot2")
library("RPostgreSQL")
library("dplyr")
options(digits = 3)
```
```{r Connection setup}
drv <- dbDriver("PostgreSQL")
con <- dbConnect(
  drv,
  dbname = "ufficioacquisti",
  host = "localhost",
  port = 15000,
  user = "postgres",
  password = "bdd2021"
)
```
```{r}
query <- "explain analyse select * from Include where numerorichiesta=0 and dipartimento='THQQYK'"
senzaIndice <- data.frame()
dbGetQuery(con, query)
dbGetQuery(con, query)
for(var in 0:29) {
  senzaIndice <- rbind(senzaIndice, dbGetQuery(con, query)[6:7,])
}
dbGetQuery(con, "create index index_num_dip on include(numerorichiesta, dipartimento)")
conIndice <- data.frame()
dbGetQuery(con, query)
dbGetQuery(con, query)
for(var in 0:29) {
  conIndice <- rbind(conIndice, dbGetQuery(con, query)[3:4,])
}
dbGetQuery(con, "drop index index_num_dip")

colnames(senzaIndice)[1] <- "Planning senza indice"
colnames(senzaIndice)[2] <- "Execution senza indice"
colnames(conIndice)[1] <- "Planning con indice"
colnames(conIndice)[2] <- "Execution con indice"

senzaIndice[, 1] <- as.numeric(gsub("([0-9]+\\.?[0-9]+)|.", "\\1", senzaIndice[, 1]))
senzaIndice[, 2] <- as.numeric(gsub("([0-9]+\\.?[0-9]+)|.", "\\1", senzaIndice[, 2]))
conIndice[, 1] <- as.numeric(gsub("([0-9]+\\.?[0-9]+)|.", "\\1", senzaIndice[, 1]))
conIndice[, 2] <- as.numeric(gsub("([0-9]+\\.?[0-9]+)|.", "\\1", senzaIndice[, 2]))

```
```{r}
nomeIndice <- "Indice_Include.Ordine_Select"
query <- "explain analyse select * from include where ordine=5;"
senzaIndice <- data.frame()
for(var in 0:49) {
  dbBegin(con)
  dbSendQuery(con, "SET LOCAL enable_seqscan = OFF;")
  dbGetQuery(con, query)[c(4, 9), ]
  senzaIndice <- rbind(senzaIndice, dbGetQuery(con, query)[c(4, 9), ])
  dbRollback(con)
}

dbSendQuery(con, "create index index_ordine on include(ordine)")
conIndice <- data.frame()
for(var in 0:49) {
  dbBegin(con)
  dbSendQuery(con, "SET LOCAL enable_seqscan = OFF;")
  dbGetQuery(con, query)[6:7, ]
  conIndice <- rbind(conIndice, dbGetQuery(con, query)[6:7, ])
  dbRollback(con)
}
dbSendQuery(con, "drop index index_ordine")

colnames(senzaIndice)[1] <- "Planning"
colnames(senzaIndice)[2] <- "Execution"
colnames(conIndice)[1] <- "Planning"
colnames(conIndice)[2] <- "Execution"

senzaIndice$"Tipo" <- "senza"
conIndice$"Tipo" <- "con"

senzaIndice[, 1] <- as.numeric(gsub("([0-9]+\\.?[0-9]+)|.", "\\1", senzaIndice[, 1]))
senzaIndice[, 2] <- as.numeric(gsub("([0-9]+\\.?[0-9]+)|.", "\\1", senzaIndice[, 2]))
conIndice[, 1] <- as.numeric(gsub("([0-9]+\\.?[0-9]+)|.", "\\1", conIndice[, 1]))
conIndice[, 2] <- as.numeric(gsub("([0-9]+\\.?[0-9]+)|.", "\\1", conIndice[, 2]))

risultato <- rbind(senzaIndice, conIndice)

write.csv2(risultato, paste("./R/csv/", paste(nomeIndice, ".csv", sep = ""), sep = ""))
```
```{r}
plot <- ggplot(risultato, aes(Planning, Execution, color=Tipo)) +
        geom_point() +
        geom_smooth(method = "lm")
ggsave(paste("./R/plots/", paste(nomeIndice, ".png", sep = ""), sep = ""))
```
```{r}
nomeIndice <- "Indice_Include.Ordine_Update"
prep_query <- "update include set ordine=NULL where Dipartimento='WLIQJC' and NumeroRichiesta=79 and Articolo = 102;"
query <- "explain analyse update include set ordine=18 where Dipartimento='WLIQJC' and NumeroRichiesta=79 and Articolo = 102;"
senzaIndice <- data.frame()
for(var in 0:49) {
  dbBegin(con)
  dbSendQuery(con, "SET LOCAL enable_seqscan = OFF;")
  dbSendQuery(con, prep_query)
  dbGetQuery(con, query)[c(4, 11), ]
  senzaIndice <- rbind(senzaIndice, dbGetQuery(con, query)[c(4, 11), ])
  dbRollback(con)
}

dbSendQuery(con, "create index index_ordine on include(ordine)")
conIndice <- data.frame()
for(var in 0:49) {
  dbBegin(con)
  dbSendQuery(con, "SET LOCAL enable_seqscan = OFF;")
  dbSendQuery(con, prep_query)
  dbGetQuery(con, query)[c(4, 11), ]
  conIndice <- rbind(conIndice, dbGetQuery(con, query)[c(4, 11), ])
  dbRollback(con)
}
dbSendQuery(con, "drop index index_ordine")

colnames(senzaIndice)[1] <- "Planning"
colnames(senzaIndice)[2] <- "Execution"
colnames(conIndice)[1] <- "Planning"
colnames(conIndice)[2] <- "Execution"

senzaIndice$"Tipo" <- "senza"
conIndice$"Tipo" <- "con"

senzaIndice[, 1] <- as.numeric(gsub("([0-9]+\\.?[0-9]+)|.", "\\1", senzaIndice[, 1]))
senzaIndice[, 2] <- as.numeric(gsub("([0-9]+\\.?[0-9]+)|.", "\\1", senzaIndice[, 2]))
conIndice[, 1] <- as.numeric(gsub("([0-9]+\\.?[0-9]+)|.", "\\1", conIndice[, 1]))
conIndice[, 2] <- as.numeric(gsub("([0-9]+\\.?[0-9]+)|.", "\\1", conIndice[, 2]))

risultato <- rbind(senzaIndice, conIndice)

write.csv2(risultato, paste("./R/csv/", paste(nomeIndice, ".csv", sep = ""), sep = ""))
```
```{r}
plot <- ggplot(risultato, aes(Planning, Execution, color=Tipo)) +
        geom_point() +
        geom_smooth(method = "lm")
ggsave(paste("./R/plots/", paste(nomeIndice, ".png", sep = ""), sep = ""))
```